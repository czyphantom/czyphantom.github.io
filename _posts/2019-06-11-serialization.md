---
layout:     post
title:      序列化方式比较
subtitle:   
date:       2019-06-11
author:     CZY
header-img: img/bg.png
catalog: true
tags:
    - Java
---

在使用RPC框架时，通常都需要对传输的数据进行序列化和反序列化，面对众多的序列化方式，RPC选取哪种就需要仔细考虑了。

在选取序列化方式时，一般需要考虑以下几个方面：
+ 通用性。是否支持跨平台、跨语言。比如Java自带的序列化只能在Java程序里使用，这种方式通用性就不好了。另外还需要考虑学习成本是否很高，如果选择一个偏门的序列化方式，那么可能就会降低开发效率。
+ 可读性。因为序列化是将字符序列转换为二进制序列，因此很多序列化方式都是难以阅读的，当然也有一些可读性强的序列化方式比如XML和JSON。
+ 性能。主要分为时间开销和空间开销。
+ 兼容性。新旧版本需要兼容。
+ 安全性。

某些序列化方式需要特殊的组件，例如ProtoBuf。使用ProtoBuf时需要先编写IDL文件（接口描述语言）,参与通讯的各方需要对通讯的内容做出规定；另外还需要IDL Compiler，由于ProtoBuf的跨语言特性，需要实现一个编译器将IDL文件转换为各语言对应的代码；Stub/Skeleton Lib：负责序列化和反序列化的工作代码，这部分代码由IDL Compiler生成。Stub是一段部署在分布式系统客户端的代码，一方面接收应用层的参数，并对其序列化后通过底层协议栈发送到服务端，另一方面接收服务端序列化后的结果数据，反序列化后交给客户端应用层；Skeleton部署在服务端，其功能与Stub相反，从传输层接收序列化参数，反序列化后交给服务端应用层，并将应用层的执行结果序列化后最终传送给客户端Stub。

下面介绍几种序列化方式：
+ XML，这种方式跨机器、跨语言，且可读性强，但是结构过于冗长，性能也不好，现在一般用作配置文件。
+ JSON，比XML更加简洁易读，解析速度也要比XML快，目前用在HTTP传输种较多。
+ Thrift，Thrift是Facebook开源提供的一个高性能，轻量级RPC服务框架，其产生正是为了满足当前大数据量、分布式、跨语言、跨平台数据通讯的需求。 但是，Thrift并不仅仅是序列化协议，而是一个RPC框架。相对于JSON和XML而言，Thrift在空间开销和解析性能上有了比较大的提升，对于对性能要求比较高的分布式系统，它是一个优秀的RPC解决方案；但是由于Thrift的序列化被嵌入到Thrift框架里面，Thrift框架本身并没有透出序列化和反序列化接口，这导致其很难和其他传输层协议共同使用。
+ Protobuf，ProtoBuf序列化数据非常紧凑，解析速度也非常快，不过支持的语言和数据类型也较少，而且ProtoBuf是一个纯粹的展现层协议，需要RPC框架自己针对该序列化方式定制传输协议。ProtoBuf提供编译器将IDL编译为C++、Java、Python文件，不过也支持对编译器进行扩展。
+ Avro，Avro提供两种序列化格式：JSON格式或者Binary格式。Binary格式在空间开销和解析性能方面可以和Protobuf媲美，JSON格式方便测试阶段的调试。Avro支持的数据类型也非常丰富，另外还可以不生成代码直接进行序列化和反序列化，Avro的设计理念偏向于动态类型语言，适合使用动态语言的项目使用。

在以上几种序列化方式中，性能最好的是Avro和ProtoBuf，可读性最好的是JSON。ProtoBuf使用时非常麻烦，需要生成代码，Avro则可以不用。综上Avro应该是最好的，不过在爱奇艺内部的RPC框架Solar建议使用的序列化方式是ProtoBuf，因为没有支持ProtoBuf。